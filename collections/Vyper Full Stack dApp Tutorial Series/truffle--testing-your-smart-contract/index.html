<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://kauri.io/collections/Vyper%20Full%20Stack%20dApp%20Tutorial%20Series/truffle--testing-your-smart-contract/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Truffle  Testing your smart contract - kauri.io</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Truffle  Testing your smart contract", url: "#_top", children: [
              {title: "Truffle: Testing your smart contract", url: "#truffle-testing-your-smart-contract_1" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-172017815-1', 'kauri.io');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="truffle-testing-your-smart-contract">Truffle  Testing your smart contract<a class="headerlink" href="#truffle-testing-your-smart-contract" title="Permanent link"></a></h1>
<h2 id="truffle-testing-your-smart-contract_1">Truffle: Testing your smart contract<a class="headerlink" href="#truffle-testing-your-smart-contract_1" title="Permanent link"></a></h2>
<p>Earlier in this series, we took a look at how to setup Truffle and use it to compile, deploy and interact with our <em>Bounties.vy</em> smart contract.</p>
<p>This article covers the steps required to write tests for our smart contract within the Truffle framework. You can write tests in Truffle projects using <a href="http://truffleframework.com/docs/getting_started/javascript-tests">Javascript</a> thanks to the <a href="https://mochajs.org/">Mocha</a> testing framework and <a href="http://www.chaijs.com/api/assert/">Chai</a> for assertions. This article focuses on the Javascript tests.</p>
<p><a href="https://github.com/iamonuwa/Bounties">You can find source code for this tutorial on GitHub</a>.</p>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link"></a></h3>
<h4 id="nodejs-76">NodeJS 7.6<a class="headerlink" href="#nodejs-76" title="Permanent link"></a></h4>
<p>Since web3.js and truffle executions are asynchronous, we use <a href="https://hackernoon.com/6-reasons-why-javascripts-async-await-blows-promises-away-tutorial-c7ec10518dd9">async/await</a> to simplify our test code and you need Node 7.6 or higher.</p>
<h4 id="truffle">Truffle<a class="headerlink" href="#truffle" title="Permanent link"></a></h4>
<pre><code class="language-shell">npm install -g truffle
</code></pre>
<p>Read more on <a href="https://truffleframework.com/docs/truffle/getting-started/installation">installing truffle in their docs</a>.</p>
<h4 id="truffle-project">Truffle Project<a class="headerlink" href="#truffle-project" title="Permanent link"></a></h4>
<p>In order to test our <em>Bounties.vy</em> smart contract we need to have a truffle project set up to compile and deploy our smart contract. Let's start with the truffle project we created earlier in the series:</p>
<!-- TODO: Update -->

<pre><code class="language-shell">$ git clone https://github.com/iamonuwa/Bounties.git
$ cd Bounties
</code></pre>
<!-- TODO: No package.json at this time -->

<h4 id="development-blockchain-ganache-cli">Development Blockchain: Ganache-CLI<a class="headerlink" href="#development-blockchain-ganache-cli" title="Permanent link"></a></h4>
<p>In order to deploy our smart contract, we need an Ethereum environment to deploy to. For this, we use Ganache-CLI to run a local development environment</p>
<p><strong>NOTE</strong>: If you have a windows machine you need to install the windows developer tools first:</p>
<pre><code class="language-shell">npm install -g windows-build-tools
</code></pre>
<p>Windows users should also install promise and bindings to ensure there are no errors later:</p>
<pre><code class="language-shell">npm install mz
npm install bindings
</code></pre>
<p>Then run:</p>
<pre><code class="language-shell">npm install -g ganache-cli
</code></pre>
<h3 id="setting-up-a-test-file">Setting up a test file<a class="headerlink" href="#setting-up-a-test-file" title="Permanent link"></a></h3>
<p>Now that we have our project setup we can create our first test:</p>
<ul>
<li>First, create a file named <strong>bounties.js</strong> inside the <strong>/test</strong> folder</li>
<li>Within our <strong>bounties.js</strong> file we need to import the <strong>Bounties.vy</strong> artifact so we can use it within our tests</li>
</ul>
<pre><code class="language-javascript">const Bounties = artifacts.require(&quot;Bounties&quot;);
</code></pre>
<ul>
<li>Now define a contract container where our tests for this contract live, usually this is the name of the contract, however, this is not required, you can use any text you like.</li>
</ul>
<pre><code class="language-javascript">contract('Bounties', function(accounts) {

  let bountiesInstance;

  beforeEach(async () =&gt; {
      bountiesInstance = await Bounties.new()
    })

});
</code></pre>
<ul>
<li>Within the contract container, we define the <code>bountiesInstance</code> variable to hold the contract instance we are testing, and a <code>beforeEach</code> block</li>
<li>The <code>beforeEach</code> block executes before each test and deploys a new instance of the <em>Bounties.vy</em> smart contract. This ensures each test is executed against a clean contract state</li>
</ul>
<p>Your <em>bounties.js</em> file should look as follows:</p>
<!-- TODO: Code better -->

<p><img alt="" src="https://ipfs.infura.io/ipfs/QmbcpryjzGpp6pVT7J8iw8VxqNvKyQk3e4gwpUrDZHENQh" /></p>
<p>At this point, we have the basic skeleton of our test file and we can test everything is set up correctly by executing the following.</p>
<p>First in a separate window start ganache-cli:</p>
<pre><code class="language-shell">ganache-cli
</code></pre>
<p>Next, run the test command:</p>
<pre><code class="language-shell">truffle test
</code></pre>
<p>Running truffle test executes all tests in your truffle projects <strong>/test</strong> folder. This does the following:</p>
<ol>
<li>Compiles your contracts</li>
<li>Runs migrations to deploy the contracts to the network</li>
<li>Runs tests against the contracts deployed on the network</li>
</ol>
<h3 id="writing-a-test">Writing a Test<a class="headerlink" href="#writing-a-test" title="Permanent link"></a></h3>
<p>Let's take a look at the <code>issueBounty</code> function:</p>
<pre><code class="language-vyper">@public
@payable
def issueBounty(_data: bytes32, _deadline: timestamp):
    assert msg.value &gt; 0
    assert _deadline &gt; block.timestamp

    bIndex: int128 = self.nextBountyIndex

    self.bounties[bIndex] = Bounty({ issuer: msg.sender, deadline: _deadline, data: _data, status: 0, amount: msg.value })
    self.nextBountyIndex = bIndex + 1

    log.BountyIssued(bIndex, msg.sender, msg.value, _data)
</code></pre>
<p>There are a few things we want to test within this function:</p>
<ul>
<li>Issuing a bounty should emit a <code>BountyIssued</code> event</li>
<li>Calling <code>issueBounty</code> should return an empty object</li>
<li><code>payable</code> keyword: Issuing a bounty without sending a value should fail</li>
<li><code>validationZero</code>:  Issuing a bounty with a value of 0 should fail</li>
<li><code>validateDeadline</code>: Issuing a bounty with a deadline less than or equal to now should fail</li>
</ul>
<h4 id="helper-functions">Helper Functions<a class="headerlink" href="#helper-functions" title="Permanent link"></a></h4>
<p>To create our bounty, we need to pass in a deadline which is greater than the current timestamp on the EVM.</p>
<p>To do this we need to write some helper functions to assist us in writing our tests:</p>
<ul>
<li>First, create a folder in the <strong>/test</strong> directory named <strong>utils</strong> and create a file <strong>time.js</strong></li>
<li>Copy the following extract into <strong>time.js</strong></li>
</ul>
<pre><code class="language-javascript">function getCurrentTime() {
  return new Promise(function(resolve) {
    web3.eth.getBlock(&quot;latest&quot;).then(function(block) {
      resolve(block.timestamp)
    });
  })
}

Object.assign(exports, {
  getCurrentTime
});
</code></pre>
<p>The above extract uses the web3 library to get the latest block from the EVM and from that return its timestamp.</p>
<ul>
<li>Create a file named <strong>assertRevert.js</strong> inside the <strong>/test/utils</strong> directory</li>
<li>Copy the following extract into <strong>assertRevert.js</strong></li>
</ul>
<pre><code class="language-javascript">var assertRevert = async (promise, message) =&gt; {
  let noFailureMessage;
  try {
    await promise;

    if (!message) {
      noFailureMessage = 'Expected revert not received'
    } else {
      noFailureMessage = message;
    }

    assert.fail();
  } catch (error) {
    if (noFailureMessage) {
      assert.fail(0, 1, message);
    }
    const revertFound = error.message.search('revert') &gt;= 0;
    assert(revertFound, `Expected &quot;revert&quot;, got ${error} instead`);
  }
};

Object.assign(exports, {
  assertRevert
});
</code></pre>
<p><img alt="" src="https://ipfs.infura.io/ipfs/QmPCxstBZ9dsJVyhZUvUc1zbzSppJkAiQCfTUEGtfphTR3" /></p>
<p>The above extract takes a promise as its first argument, which would be a web3 transaction, and an assertion fail message as the next. It wraps the promise in a try and catches the error, if the promise fails it checks if the error message contains the string "revert”.</p>
<p>We can now import our helper function into our <strong>bounties.js</strong> test file, by adding the following lines:</p>
<pre><code class="language-javascript">const getCurrentTime = require('./utils/time').getCurrentTime;
const assertRevert = require('./utils/assertRevert').assertRevert;
const dayInSeconds = 86400;
</code></pre>
<p>We also added a <code>dayInSeconds</code> constant to help us add days.</p>
<h4 id="happy-path-for-tests">Happy Path for tests<a class="headerlink" href="#happy-path-for-tests" title="Permanent link"></a></h4>
<p><strong>Note: all the following tests should be placed in the bounties.js file</strong></p>
<p>The test for our first happy path looks like this:</p>
<pre><code class="language-javascript">it(&quot;Should allow a user to issue a new bounty&quot;, async () =&gt; {
    let time = await getCurrentTime();
    let tx = await bountiesInstance.issueBounty(
      &quot;0x736f6d6520726571756972656d656e7473&quot;,
      1691452800,
      { from: accounts[0], value: 500000000000 }
    );
    assert.strictEqual(
      tx.receipt.logs.length,
      1,
      &quot;issueBounty() call did not log 1 event&quot;
    );
    assert.strictEqual(
      tx.logs.length,
      1,
      &quot;issueBounty() call did not log 1 event&quot;
    );
    const logBountyIssued = tx.logs[0];
    assert.strictEqual(
      logBountyIssued.event,
      &quot;BountyIssued&quot;,
      &quot;issueBounty() call did not log event BountyIssued&quot;
    );
    expect(logBountyIssued.args._id).to.eq.BN(0);
    assert.strictEqual(
      logBountyIssued.args._issuer,
      accounts[0],
      &quot;BountyIssued event logged did not have expected issuer&quot;
    );
    assert.strictEqual(
      logBountyIssued.args._amount.toNumber(),
      500000000000,
      &quot;BountyIssued event logged did not have expected amount&quot;
    );
  });
</code></pre>
<p>There is a lot going on here, so let's break it down:</p>
<ul>
<li>Each test starts with the function <code>it()</code> which takes a description of the test as its first arguments and a callback function as the next. We use <code>async()</code> as the callback so we can use <code>await</code>.</li>
<li>We then invoke an <code>issueBounty</code> transaction on our <code>bountiesInstance</code> object, using our <code>getCurrentTIme()</code> helper to ensure our deadline is valid.</li>
<li>The transaction is sent from <code>account[0]</code> with a value of <code>500000000000000000</code>.</li>
<li>We then <code>assert</code> that our transaction receipt contains a log of exactly 1 event.</li>
<li>We then assert that the details of the event are as expected.</li>
<li>Notice, we used <code>expect</code> to check if the <code>id</code> is equal to BigNumber 0. You cannot use the <code>Assert</code> keyword in this case because <code>BN</code> is not a function in it. To test for <code>BN</code>, we had to install <code>bignumber.js</code>, <code>chai</code>, <code>bn-chai</code> using npm and add the following at the beginning of the file:</li>
</ul>
<pre><code class="language-javascript">const BN = require(&quot;bignumber.js&quot;);
const chai = require(&quot;chai&quot;);
const bnChai = require(&quot;bn-chai&quot;);
const { expect } = chai;
chai.use(bnChai(BN));
</code></pre>
<p>Our second happy path tests making a call to <code>issueBounty</code> rather than sending a transaction:</p>
<pre><code class="language-javascript">it(&quot;Should not allow a user to issue a bounty without sending ETH&quot;, async () =&gt; {
    let time = await getCurrentTime()
    assertRevert(bountiesInstance.issueBounty('0x736f6d6520726571756972656d656e7473',
                                time + (dayInSeconds * 2),
                                {from: accounts[0]}), &quot;Bounty issued without sending ETH&quot;);

  });
</code></pre>
<p>Above we add <code>.call</code> to <code>issueBounty</code> to make a call to the function rather than issuing a transaction. This returns the return value of the function rather than a transaction receipt.</p>
<p><strong>NOTE: Because our result is a <code>BigNumber</code>, we need to call <code>.toNumber()</code> in our assert function.</strong></p>
<h4 id="error-path">Error Path<a class="headerlink" href="#error-path" title="Permanent link"></a></h4>
<p>Our error path tests involve sending a transaction with invalid inputs as an argument to our <code>assertRevert</code> helper function. To test our <code>payable</code> keyword, we invoke a transaction without setting a value:</p>
<pre><code class="language-javascript">it(&quot;Should not allow a user to issue a bounty without sending ETH&quot;, async () =&gt; {
      let time = await getCurrentTime()
      assertRevert(bountiesInstance.issueBounty(&quot;data&quot;,
                                  time + (dayInSeconds * 2),
                                  {from: accounts[0]}), &quot;Bounty issued without sending ETH&quot;);

    });
</code></pre>
<p>To test <code>msg.value &gt; 0</code> we invoke our transaction with a value of 0:</p>
<pre><code class="language-javascript">it(&quot;Should not allow a user to issue a bounty when sending value of 0&quot;, async () =&gt; {
    let time = await getCurrentTime()
    assertRevert(bountiesInstance.issueBounty('0x736f6d6520726571756972656d656e7473',
                                time + (dayInSeconds * 2),
                                {from: accounts[0], value: 0}), &quot;Bounty issued when sending value of 0&quot;);

  });
</code></pre>
<p>To test our <code>_deadline &gt; block.timestamp</code>, we need to send two transactions, one with a deadline set in the past, and another with a deadline set as now:</p>
<pre><code class="language-javascript">it(&quot;Should not allow a user to issue a bounty with a deadline in the past&quot;, async () =&gt; {
    let time = await getCurrentTime()
    assertRevert(bountiesInstance.issueBounty('0x736f6d6520726571756972656d656e7473',
                                time - 1,
                                {from: accounts[0], value: 0}), &quot;Bounty issued with deadline in the past&quot;);

  });

  it(&quot;Should not allow a user to issue a bounty with a deadline of now&quot;, async () =&gt; {
    let time = await getCurrentTime()
    assertRevert(bountiesInstance.issueBounty('0x736f6d6520726571756972656d656e7473',
                                time,
                                {from: accounts[0], value: 0}), &quot;Bounty issued with deadline of now&quot;);

  });
</code></pre>
<p>If we run the <code>truffle test</code> command we should see the following:</p>
<pre><code class="language-shell">$ truffle test

Contract: Bounties
    ✓ Should allow a user to issue a new bounty (92ms)
    ✓ Should return an integer when calling issueBounty (46ms)
    ✓ Should not allow a user to issue a bounty without sending ETH
    ✓ Should not allow a user to issue a bounty when sending value of 0
    ✓ Should not allow a user to issue a bounty with a deadline in the past
    ✓ Should not allow a user to issue a bounty with a deadline of now
    ✓ Should not allow a user to fulfil an existing bounty where the deadline has passed (103ms)


  7 passing (1s)
</code></pre>
<h4 id="time-travel">Time travel<a class="headerlink" href="#time-travel" title="Permanent link"></a></h4>
<p>One of the main tests is to check that a fulfilment should not be accepted if the deadline has passed. In order to test this, we need to add a helper function which advances the timestamp of the EVM.</p>
<p>In the <strong>/test/utils/time.js</strong> file add the following:</p>
<pre><code class="language-javascript">function increaseTimeInSeconds(increaseInSeconds) {
    return new Promise(function(resolve) {
        web3.currentProvider.send({
            jsonrpc: &quot;2.0&quot;,
            method: &quot;evm_increaseTime&quot;,
            params: [increaseInSeconds],
            id: new Date().getTime()
        }, resolve);
    });
};
</code></pre>
<p>This function calls the <code>evm_increaseTime</code> RPC function of the ganache EVM to increase the EVM block timestamp.</p>
<p>Add the new <code>increaseTimeInSeconds</code> function to the exports section of the file:</p>
<pre><code class="language-javascript">Object.assign(exports, {
  increaseTimeInSeconds,
  getCurrentTime
});
</code></pre>
<p>In the <strong>bounties.js</strong> test file add the following line to import our new helper function:</p>
<pre><code class="language-javascript">const increaseTimeInSeconds = require('./utils/time').increaseTimeInSeconds;
</code></pre>
<p>We can then use this in our test as follows:</p>
<pre><code class="language-javascript">it(&quot;Should not allow a user to fulfil an existing bounty where the deadline has passed&quot;, async () =&gt; {
  let time = await getCurrentTime()
  await bountiesInstance.issueBounty(&quot;data&quot;,
                    time+ (dayInSeconds * 2),
                    {from: accounts[0], value: 500000000000});

  await increaseTimeInSeconds((dayInSeconds * 2)+1)

  assertRevert(bountiesInstance.fulfillBounty(0,&quot;data&quot;,{from: accounts[1]}), &quot;Fulfillment accepted when deadline has passed&quot;);

});
</code></pre>
<h3 id="try-it-yourself">Try it yourself<a class="headerlink" href="#try-it-yourself" title="Permanent link"></a></h3>
<p>Now that you have seen how to test the <code>issueBounty</code> function, try adding tests for the following functions:</p>
<ul>
<li><code>fulfilBounty</code></li>
<li><code>acceptFulfilment</code></li>
<li><code>cancelBounty</code></li>
</ul>
<p>You can find the <a href="https://github.com/iamonuwa/Bounties/blob/master/test/bounties.js">complete bounties.js test file here for reference</a></p>
<h3 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link"></a></h3>
<ul>
<li>Read the next guide: <a href="https://kauri.io/article/86903f66d39d4379a2e70bd583700ecf/truffle:-adding-a-frontend-with-react-box">Truffle: Adding a Frontend with React Box</a></li>
<li>Learn more about the Truffle suite of tools from the <a href="https://truffleframework.com/">website</a></li>
</ul>
<blockquote>
<p>If you enjoyed this guide, or have any suggestions or questions, let me know in the comments.</p>
<p>If you have found any errors, feel free to update this guide by selecting the <strong>'Update Article'</strong> option in the right hand menu, and/or <a href="https://github.com/iamonuwa/Bounties">update the code</a></p>
</blockquote>
<hr />
<ul>
<li><strong>Kauri original title:</strong> Truffle  Testing your smart contract</li>
<li><strong>Kauri original link:</strong> https://kauri.io/truffle-testing-your-smart-contract/ebc4a29cc1c044fdba99631796ffbd93/a</li>
<li><strong>Kauri original author:</strong> Onuwa Nnachi Isaac (@iamonuwa)</li>
<li><strong>Kauri original Publication date:</strong> 2019-08-29</li>
<li><strong>Kauri original tags:</strong> smart-contract, testing, vyper</li>
<li><strong>Kauri original hash:</strong> QmX6Cjg1tiFC6RcCrXGodStwSP2t6CsjmYPA2FxvMRYBLo</li>
<li><strong>Kauri original checkpoint:</strong> QmUP9qZg9vxiTYmDyCRfVzpyYLQbtd6r3GAM7CyqCFhShv</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../tools-for-working-with-vyper/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../tools-for-working-with-vyper/" class="btn btn-xs btn-link">
        Tools for working with Vyper
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../truffle--smart-contract-compilation-and-deploymen/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../truffle--smart-contract-compilation-and-deploymen/" class="btn btn-xs btn-link">
        Truffle  Smart Contract Compilation & Deployment
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/kauri-io/archive/edit/main/docs/collections/Vyper Full Stack dApp Tutorial Series/truffle--testing-your-smart-contract.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>