<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://kauri.io/collections/Build%20your%20very%20own%20self-hosting%20platform%20with%20Raspberry%20Pi%20and%20Kubernetes/%2888%29-deploy-prometheus-and-grafana-to-monitor-a-k/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>(8/8) Deploy Prometheus and Grafana to monitor a Kubernetes cluster - kauri.io</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "(8/8) Deploy Prometheus and Grafana to monitor a Kubernetes cluster", url: "#_top", children: [
              {title: "This article is part of the series Build your very own self-hosting platform with Raspberry Pi and Kubernetes", url: "#this-article-is-part-of-the-series-build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes" },
              {title: "Introduction", url: "#introduction" },
              {title: "Prerequisite", url: "#prerequisite" },
              {title: "Configuration", url: "#configuration" },
              {title: "Installation", url: "#installation" },
              {title: "Dashboard", url: "#dashboard" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-172017815-1', 'kauri.io');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="88-deploy-prometheus-and-grafana-to-monitor-a-kubernetes-cluster">(8/8) Deploy Prometheus and Grafana to monitor a Kubernetes cluster<a class="headerlink" href="#88-deploy-prometheus-and-grafana-to-monitor-a-kubernetes-cluster" title="Permanent link"></a></h1>
<p><img alt="" src="https://ipfs.infura.io/ipfs/QmPkbAuQryPTYbKiZ3X542xCXrkXUwXYWtQfwYLtzh2iER" /></p>
<p><br /></p>
<h4 id="this-article-is-part-of-the-series-build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes">This article is part of the series <a href="https://kauri.io/build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes/5e1c3fdc1add0d0001dff534/c">Build your very own self-hosting platform with Raspberry Pi and Kubernetes</a><a class="headerlink" href="#this-article-is-part-of-the-series-build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes" title="Permanent link"></a></h4>
<ol>
<li><a href="https://kauri.io/build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes-introduction/1229f21044ef4bff8df35875d6803776/a">Introduction</a></li>
<li><a href="https://kauri.io/install-raspbian-operating-system-and-prepare-the-system-for-kubernetes/7df2a9f9cf5f4f6eb217aa7223c01594/a">Install Raspbian Operating-System and prepare the system for Kubernetes</a></li>
<li><a href="https://kauri.io/install-and-configure-a-kubernetes-cluster-with-k3s-to-self-host-applications/418b3bc1e0544fbc955a4bbba6fff8a9/a">Install and configure a Kubernetes cluster with k3s to self-host applications</a></li>
<li><a href="https://kauri.io/deploy-nextcloud-on-kuberbetes:-the-self-hosted-dropbox/f958350b22794419b09fc34c7284b02e/a">Deploy NextCloud on Kuberbetes: The self-hosted Dropbox</a></li>
<li><a href="https://kauri.io/self-host-your-media-center-on-kubernetes-with-plex-sonarr-radarr-transmission-and-jackett/8ec7c8c6bf4e4cc2a2ed563243998537/a">Self-host your Media Center On Kubernetes with Plex, Sonarr, Radarr, Transmission and Jackett</a></li>
<li><a href="https://kauri.io/-selfhost-pihole-on-kubernetes-and-block-ads-and/5268e3daace249aba7db0597b47591ef/a">Self-host Pi-Hole on Kubernetes and block ads and trackers at the network level</a></li>
<li><a href="https://kauri.io/selfhost-your-password-manager-with-bitwarden/b2187730d4294626b28d1d938057e2e0/a">Self-host your password manager with Bitwarden</a></li>
<li><strong>Deploy Prometheus and Grafana to monitor a Kubernetes cluster</strong></li>
</ol>
<p><br />
<br /></p>
<h3 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link"></a></h3>
<p>Monitoring is an important part of the maintenance of a Kubernetes cluster to gain visibility on the infrastructure and the running applications and consequently detect anomalies and undesirables behaviours (service downtime, errors, slow responses).</p>
<p><a href="https://prometheus.io/">Prometheus</a> and <a href="https://grafana.com/">Grafana</a> is a common combination of tools to build up a monitoring system where Prometheus acts as a data collector pulling periodically metrics from different systems and Grafana as a dashboard solution to visualise the data.</p>
<p><img alt="" src="https://ipfs.infura.io/ipfs/QmW2155L91oNeMp9H2VR1nSeoB5GchppXQJCjfTt6wtSW4" /></p>
<p>Specifically for Kubernetes, a great Open-Source project called <a href="https://github.com/carlosedp/cluster-monitoring"><strong>cluster-monitoring</strong></a> offers a scripts to automate the installation and configuration of Prometheus + Grafana and provides a lot of dashboards for Kubernetes out of the box.</p>
<p><br />
<br /></p>
<h3 id="prerequisite">Prerequisite<a class="headerlink" href="#prerequisite" title="Permanent link"></a></h3>
<p>In order to run entirely the tutorial, we will need:</p>
<ul>
<li>A running Kubernetes cluster (see previous articles if you haven't set this up yet)</li>
<li>Install Golang on the machine that runs <code>kubectl</code></li>
</ul>
<pre><code>$ sudo apt  install golang-go
$ export PATH=$PATH:$(go env GOPATH)/bin
$ export GOPATH=$(go env GOPATH)
</code></pre>
<p><br />
<br /></p>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link"></a></h3>
<p><strong>1. Clone the repository</strong> </p>
<p>Clone the repository <code>cluster-monitoring</code> with the following command (change ~/workspace/cluster-monitoring by the target folder of your choice):</p>
<pre><code>$ git clone https://github.com/carlosedp/cluster-monitoring.git ~/workspace/cluster-monitoring
</code></pre>
<p><br />
<strong>2. Configuration</strong></p>
<p>Then open the file <code>~/workspace/cluster-monitoring/vars.jsonnet</code> and modify the following sections:</p>
<p>Enable k3s and put the IP of our master node <code>kube-master</code>.</p>
<pre><code class="language-json">  k3s: {
    enabled: true,
    master_ip: ['192.168.0.22'],
  },
</code></pre>
<p><br />
The suffix domain is used to deploy an ingress to access Prometheus <code>prometheus.&lt;suffixDomain&gt;</code> and Grafana <code>grafana.&lt;suffixDomain&gt;</code>. You can manually configure a DNS entry to point to <code>192.168.0.240</code> (Load Balancer IP of the Nginx) or used <a href="https://nip.io/">nip.io</a> to automatically resolve a domain to an IP (basically it resolves <code>&lt;anything&gt;.&lt;ip&gt;.nip.io</code> by <code>&lt;ip&gt;</code> without requiring any other configuration).</p>
<pre><code class="language-json">    suffixDomain: '192.168.0.240.nip.io',
</code></pre>
<p><br />
Enable the persistence to store the metrics (Prometheus) and dashboard settings (Grafana).</p>
<pre><code class="language-json">  enablePersistence: {
    prometheus: true,
    grafana: true,
  },
</code></pre>
<p><br />
<br /></p>
<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link"></a></h3>
<p>Once we've done the configuration part, we can now proceed to the installation.</p>
<p>Navigate into the folder <code>cluster-monitoring</code>.</p>
<pre><code>$ cd ~/workspace/cluster-monitoring/
</code></pre>
<p><br />
First run <code>make vendor</code> to download all the necessary packages.</p>
<pre><code>$ make vendor

rm -rf vendor
/home/gjeanmart/go/bin/jb install
GET https://github.com/coreos/kube-prometheus/archive/285624d8fbef01923f7b9772fe2da21c5698a666.tar.gz 200
GET https://github.com/brancz/kubernetes-grafana/archive/57b4365eacda291b82e0d55ba7eec573a8198dda.tar.gz 200
(...)
GET https://github.com/metalmatze/slo-libsonnet/archive/5ddd7ffc39e7a54c9aca997c2c389a8046fab0ff.tar.gz 200
</code></pre>
<p><br />
Finally deploy the monitoring stack with the command <code>make deploy</code>.</p>
<pre><code>$ make deploy

rm -rf manifests
./scripts/build.sh main.jsonnet /home/gjeanmart/go/bin/jsonnet
using jsonnet from arg
+ set -o pipefail
+ rm -rf manifests
+ mkdir manifests
+ /home/gjeanmart/go/bin/jsonnet -J vendor -m manifests main.jsonnet
+ xargs '-I{}' sh -c 'cat {} | gojsontoyaml &gt; {}.yaml; rm -f {}' -- '{}'
kubectl apply -f ./manifests/
namespace/monitoring created
(...)
servicemonitor.monitoring.coreos.com/kubelet created
</code></pre>
<p><strong>Repeat this command again if you see some errors as a result.</strong></p>
<p><br />
Once deployed, check that the namespace <code>monitoring</code> has all the components up and running.</p>
<pre><code>$ kubectl get pods -n monitoring -o wide

NAME                                   READY   STATUS    RESTARTS   AGE     IP             NODE          NOMINATED NODE   READINESS GATES
prometheus-operator-56d66c5dc6-8ljsb   1/1     Running   0          7m54s   10.42.0.154    kube-master   &lt;none&gt;           &lt;none&gt;
alertmanager-main-0                    2/2     Running   0          7m43s   10.42.0.155    kube-master   &lt;none&gt;           &lt;none&gt;
kube-state-metrics-5c6fb7544b-6p956    3/3     Running   0          7m36s   10.42.0.157    kube-master   &lt;none&gt;           &lt;none&gt;
node-exporter-h48d6                    2/2     Running   0          7m34s   192.168.0.22   kube-master   &lt;none&gt;           &lt;none&gt;
prometheus-adapter-679db899b7-x89l6    1/1     Running   0          7m22s   10.42.0.158    kube-master   &lt;none&gt;           &lt;none&gt;
grafana-6fb45f9c8-j8qbv                1/1     Running   0          7m41s   10.42.0.159    kube-master   &lt;none&gt;           &lt;none&gt;
prometheus-k8s-0                       3/3     Running   1          7m15s   10.42.0.161    kube-master   &lt;none&gt;           &lt;none&gt;
</code></pre>
<p><br />
<br /></p>
<h3 id="dashboard">Dashboard<a class="headerlink" href="#dashboard" title="Permanent link"></a></h3>
<p>After configuring and deploying our Kubernetes Monitoring stack, you can now access the different components:</p>
<ul>
<li>Prometheus: <a href="https://prometheus.192.168.0.240.nip.io">https://prometheus.192.168.0.240.nip.io</a></li>
<li>Grafana: <a href="https://grafana.192.168.0.240.nip.io">https://grafana.192.168.0.240.nip.io</a> </li>
</ul>
<p>Click on the Grafana link and login with the default login/password <code>admin/admin</code> (you will be asked to choose a new password)</p>
<p><img alt="" src="https://i.imgur.com/a3a0Ocu.png" /></p>
<p>You can now finally enjoy a lot of pre-configured dashboards for your Kubernetes cluster.</p>
<p><img alt="" src="https://i.imgur.com/ASJhgZ3.png" /></p>
<hr />
<ul>
<li><strong>Kauri original title:</strong> (8/8) Deploy Prometheus and Grafana to monitor a Kubernetes cluster</li>
<li><strong>Kauri original link:</strong> https://kauri.io/88-deploy-prometheus-and-grafana-to-monitor-a-kube/186a71b189864b9ebc4ef7c8a9f0a6b5/a</li>
<li><strong>Kauri original author:</strong> Grégoire Jeanmart (@gregjeanmart)</li>
<li><strong>Kauri original Publication date:</strong> 2020-04-01</li>
<li><strong>Kauri original tags:</strong> self-hosting, analytics, kubernetes, grafana, prometheus, monitoring</li>
<li><strong>Kauri original hash:</strong> QmVCXG2Uum6gQkKbE1dQprGJ1NUmye7uTPvuiqojGDFupw</li>
<li><strong>Kauri original checkpoint:</strong> QmZUeDv5bCt7vrRCQbwPMQf812VWip98dcsMJHdYdaiQ3d</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../A%20Hackathon%20Survival%20Guide/the-hack%21-what-is-a-hackathon/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../A%20Hackathon%20Survival%20Guide/the-hack%21-what-is-a-hackathon/" class="btn btn-xs btn-link">
        The Hack?!? What is a hackathon?
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%2878%29-self-host-your-password-manager-with-bitward/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%2878%29-self-host-your-password-manager-with-bitward/" class="btn btn-xs btn-link">
        (7/8) Self-host your password manager with Bitwarden
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/kauri-io/archive/edit/main/docs/collections/Build your very own self-hosting platform with Raspberry Pi and Kubernetes/(88)-deploy-prometheus-and-grafana-to-monitor-a-k.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>